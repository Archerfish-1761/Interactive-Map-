<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Interactive Map with Multiple Basemaps</title>
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    html, body { margin: 0; padding: 0; height: 100%; }
    #map { width: 100%; height: 100%; }
    /* Search bar styling */
    #search-bar {
      position: absolute; top: 20px; left: 50%; transform: translateX(-50%);
      z-index: 1000; background: rgba(255,255,255,0.9);
      padding: 12px 16px; border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      display: flex; align-items: center;
    }
    #search-input {
      border: 1px solid #ccc; padding: 8px 12px;
      border-radius: 8px; width: 250px; font-size: 14px;
      outline: none;
    }
    #search-input:focus { border-color: #4285F4; box-shadow: 0 0 4px rgba(66,133,244,0.6); }
    #search-btn {
      margin-left: 12px; padding: 8px 16px;
      font-size: 14px; border: none; border-radius: 8px;
      cursor: pointer; background: #4285F4; color: #fff;
      outline: none;
    }
    #search-btn:hover { background: #357ae8; }

    /* Bottom-left controls wrapper */
    #controls-bottom-left {
      position: absolute; bottom: 20px; left: 20px; z-index: 1000;
      display: flex; align-items: center; gap: 12px;
    }

    /* Basemap selector card */
    #basemap-select-container {
      position: static; /* sits inside the wrapper */
      background: rgba(255,255,255,0.9);
      padding: 6px 10px; border-radius: 4px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      font-size: 14px;
    }

    /* Thunderforest selector stays above */
    #tf-select-container {
      position: absolute; left: 20px; bottom: 80px; z-index: 1000;
      background: rgba(255,255,255,0.9);
      padding: 6px 10px; border-radius: 4px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      font-size: 14px;
    }

    select {
      border: 1px solid #ccc; padding: 4px;
      border-radius: 4px; font-size: 14px; cursor: pointer;
    }

    /* View buttons (street/satellite/dark) */
    #view-buttons {
      display: flex; gap: 10px; /* inline next to basemap */
    }
    .view-btn {
      width: 56px; height: 56px; /* bigger */
      border: 2px solid transparent; border-radius: 12px; /* rounded square */
      background: rgba(255,255,255,0.95);
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      cursor: pointer; display: flex; align-items: center; justify-content: center;
      font-size: 20px; color: #333; box-sizing: border-box;
      transition: border-color 0.15s ease, background 0.15s ease;
    }
    .view-btn:hover { border-color: #4285F4; }
    .view-btn.active { border-color: #4285F4; }
    .view-btn svg { width: 28px; height: 28px; display: block; }
    .view-btn img { width: 28px; height: 28px; display: block; object-fit: contain; }
  </style>
</head>
<body>
  <div id="map"></div>

  <!-- Search bar -->
  <div id="search-bar">
    <input type="text" id="search-input" placeholder="Search location..." />
    <button id="search-btn">Go</button>
  </div>

  <!-- Bottom-left controls: view buttons -->
  <div id="controls-bottom-left">
    <div id="view-buttons">
      <button class="view-btn" id="btn-street" title="Street View" aria-label="Street View">
        <!-- Upright road icon -->
        <svg viewBox="0 0 64 64" role="img" aria-hidden="true">
          <g transform="rotate(180 32 32)">
            <!-- Road body (now upright) -->
            <path d="M18 4 L26 60 H38 L46 4 Z" fill="currentColor"/>
            <!-- Center dashed line -->
            <path d="M32 12 v8 M32 26 v8 M32 40 v8" stroke="#fff" stroke-width="4" stroke-linecap="round"/>
            <!-- Inner edge highlights -->
            <path d="M24 8 L28 60" stroke="#fff" stroke-width="2" stroke-linecap="round" opacity="0.9"/>
            <path d="M40 8 L36 60" stroke="#fff" stroke-width="2" stroke-linecap="round" opacity="0.9"/>
          </g>
        </svg>
      </button>
      <button class="view-btn" id="btn-sat" title="Satellite View" aria-label="Satellite View">
        <!-- Inline satellite SVG icon -->
        <svg viewBox="0 0 24 24" role="img" aria-hidden="true">
          <!-- Dish bowl -->
          <path d="M3 21a9 9 0 0 1 12-12" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          <!-- Mast -->
          <path d="M9 15l-3 6" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          <!-- Feed arm -->
          <path d="M9 15l4-4" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          <!-- Feed head -->
          <circle cx="13" cy="11" r="1.2" fill="currentColor"/>
          <!-- Signal waves -->
          <path d="M15 7c1.66 0 3 1.34 3 3" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          <path d="M15 4c3.31 0 6 2.69 6 6" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
      </button>
      <button class="view-btn" id="btn-dark" title="Dark Mode">&#127769;</button>
      <button class="view-btn" id="btn-terrain" title="Terrain (OpenTopoMap)">⛰️</button>
    </div>
    </div>

  <!-- Thunderforest style selector -->
  <div id="tf-select-container">
    <label for="tf-select">Thunderforest:</label>
    <select id="tf-select">
      <option value="cycle">OpenCycleMap</option>
      <option value="transport">Transport</option>
      <option value="landscape">Landscape</option>
      <option value="outdoors" selected>Outdoors</option>
      <option value="transport-dark">Transport Dark</option>
      <option value="mobile-atlas">Mobile Atlas</option>
      <option value="neighbourhood">Neighbourhood</option>
      <option value="atlas">Atlas</option>
    </select>
  </div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    // --- Setup & Map ---
    function getQueryParam(name) { return new URLSearchParams(window.location.search).get(name); }
    const defaultLat = 53.5721865, defaultLng = 15.4266266, defaultZoom = 4.5;
    const lat = parseFloat(getQueryParam('lat')) || defaultLat;
    const lng = parseFloat(getQueryParam('lng')) || defaultLng;
    const zoom = parseFloat(getQueryParam('zoom')) || defaultZoom;
    const map = L.map('map').setView([lat, lng], zoom);
    const apiKey = 'fb657e144f5246efa57cbabbae7db1d5';

    // --- Layers ---
    const layers = {
      darkmatter: L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { subdomains: 'abcd', maxZoom: 19, attribution: '© OSM contributors © CARTO' }),
      esri: L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}', { maxZoom: 19, attribution: 'Tiles © Esri' }),
      'esri-imagery': L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { maxZoom: 19, attribution: 'Tiles © Esri' }),
      opentopo: L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', { maxZoom: 17, attribution: '© OSM contributors, SRTM | CC-BY-SA' }),
      cycle: L.tileLayer(`https://tile.thunderforest.com/cycle/{z}/{x}/{y}.png?apikey=${apiKey}`, { maxZoom: 22, attribution: '© OSM contributors © Thunderforest' }),
      transport: L.tileLayer(`https://tile.thunderforest.com/transport/{z}/{x}/{y}.png?apikey=${apiKey}`, { maxZoom: 22, attribution: '© OSM contributors © Thunderforest' }),
      landscape: L.tileLayer(`https://tile.thunderforest.com/landscape/{z}/{x}/{y}.png?apikey=${apiKey}`, { maxZoom: 22, attribution: '© OSM contributors © Thunderforest' }),
      outdoors: L.tileLayer(`https://tile.thunderforest.com/outdoors/{z}/{x}/{y}.png?apikey=${apiKey}`, { maxZoom: 22, attribution: '© OSM contributors © Thunderforest' }),
      'transport-dark': L.tileLayer(`https://tile.thunderforest.com/transport-dark/{z}/{x}/{y}.png?apikey=${apiKey}`, { maxZoom: 22, attribution: '© OSM contributors © Thunderforest' }),
      'mobile-atlas': L.tileLayer(`https://tile.thunderforest.com/mobile-atlas/{z}/{x}/{y}.png?apikey=${apiKey}`, { maxZoom: 22, attribution: '© OSM contributors © Thunderforest' }),
      neighbourhood: L.tileLayer(`https://tile.thunderforest.com/neighbourhood/{z}/{x}/{y}.png?apikey=${apiKey}`, { maxZoom: 22, attribution: '© OSM contributors © Thunderforest' }),
      atlas: L.tileLayer(`https://tile.thunderforest.com/atlas/{z}/{x}/{y}.png?apikey=${apiKey}`, { maxZoom: 22, attribution: '© OSM contributors © Thunderforest' })
    };

    // Default layer
    let currentLayer = layers.outdoors.addTo(map);

    // --- UI refs (fix for missing declarations) ---
    const btnStreet = document.getElementById('btn-street');
    const btnSat = document.getElementById('btn-sat');
    const btnDark = document.getElementById('btn-dark');
    const btnTerrain = document.getElementById('btn-terrain');
    const tfSelect = document.getElementById('tf-select');

    // --- Selection state ---
    function updateViewButtons() {
      btnStreet.classList.toggle('active', currentLayer === layers.esri);
      btnSat.classList.toggle('active', currentLayer === layers['esri-imagery']);
      btnDark.classList.toggle('active', currentLayer === layers.darkmatter);
      btnTerrain.classList.toggle('active', currentLayer === layers.opentopo);
    }
    updateViewButtons();

    // --- Dropdown handlers ---
    tfSelect.addEventListener('change', function() {
      map.removeLayer(currentLayer);
      currentLayer = layers[this.value].addTo(map);
      updateViewButtons();
    });

    // --- View buttons ---
    btnStreet.addEventListener('click', () => {
      map.removeLayer(currentLayer);
      currentLayer = layers.esri.addTo(map);
      updateViewButtons();
    });
    btnSat.addEventListener('click', () => {
      map.removeLayer(currentLayer);
      currentLayer = layers['esri-imagery'].addTo(map);
      updateViewButtons();
    });
    btnDark.addEventListener('click', () => {
      map.removeLayer(currentLayer);
      currentLayer = layers.darkmatter.addTo(map);
      updateViewButtons();
    });
    btnTerrain.addEventListener('click', () => {
      map.removeLayer(currentLayer);
      currentLayer = layers.opentopo.addTo(map);
      updateViewButtons();
    });

    // --- Marker group ---
    const markers = L.layerGroup().addTo(map);
    markers.addLayer(L.marker([lat, lng]).bindPopup(`Lat: ${lat.toFixed(6)}, Lng: ${lng.toFixed(6)}`).openPopup());

    // --- Search ---
    const inputEl = document.getElementById('search-input');
    const btn = document.getElementById('search-btn');
    function searchLocation() {
      const q = inputEl.value.trim(); if (!q) return;
      fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}`)
        .then(res => res.json()).then(data => {
          if (data.length) {
            const p = data[0];
            const la = parseFloat(p.lat), lo = parseFloat(p.lon);
            map.setView([la, lo], 13);
            markers.clearLayers();
            markers.addLayer(L.marker([la, lo]).bindPopup(p.display_name).openPopup());
          } else {
            alert('Location not found.');
          }
        }).catch(e => {console.error(e); alert('Error searching location.');});
    }
    btn.addEventListener('click', searchLocation);
    inputEl.addEventListener('keyup', e => { if (e.key === 'Enter') searchLocation(); });

    // --- Self-tests (basic runtime checks) ---
    (function selfTests(){
      console.assert(map instanceof L.Map, 'Map instance should be created');
      console.assert(btnStreet && btnSat && btnDark && btnTerrain, 'View buttons should exist');
      console.assert(btnStreet.querySelector('svg'), 'Street button should contain an SVG icon');
      console.assert(btnSat.querySelector('svg'), 'Satellite button should contain an SVG icon');
      console.assert(tfSelect, 'Thunderforest dropdown should exist');
      console.assert(layers['esri-imagery'] && layers.esri && layers.outdoors && layers.opentopo, 'Core layers exist');
      console.assert(currentLayer, 'A current layer should be active');
      console.assert(tfSelect.value === 'outdoors', 'Thunderforest default should be Outdoors');
      // Non-destructive active-state tests for buttons
      const saved = currentLayer;
      try {
        currentLayer = layers.esri; updateViewButtons();
        console.assert(btnStreet.classList.contains('active'), 'Street button should be active when ESRI streets selected');
        currentLayer = layers['esri-imagery']; updateViewButtons();
        console.assert(btnSat.classList.contains('active'), 'Satellite button should be active when ESRI imagery selected');
        currentLayer = layers.darkmatter; updateViewButtons();
        console.assert(btnDark.classList.contains('active'), 'Dark button should be active when Dark Matter selected');
        currentLayer = layers.opentopo; updateViewButtons();
        console.assert(btnTerrain.classList.contains('active'), 'Terrain button should be active when OpenTopoMap selected');
      } finally {
        currentLayer = saved; updateViewButtons();
      }
    })();
  </script>
</body>
</html>
